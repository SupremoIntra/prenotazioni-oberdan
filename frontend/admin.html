<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Admin - Griglia Prenotazioni</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background-color: #f0f8ff; text-align: center; }
  h1 { color: #1E90FF; margin-bottom: 15px; }
  
  #controls { margin-bottom: 15px; }
  button {
    padding: 6px 12px;
    margin: 5px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    color: #fff;
    transition: transform 0.1s;
  }
  button:hover { transform: scale(1.05); }
  #resetBtn { background-color: #FF6347; }
  #resetBtn:hover { background-color: #e5533b; }
  #exportBtn { background-color: #32CD32; }
  #exportBtn:hover { background-color: #28a745; }

  #adminGrid {
    display: grid;
    justify-content: center;
    grid-gap: 5px;
    margin-top: 10px;
  }

  .seat {
    width: 50px; height: 50px;
    display: flex; align-items: center; justify-content: center;
    border-radius: 5px; font-weight: bold; cursor: pointer;
    color: #fff; user-select: none; position: relative;
    transition: transform 0.1s;
  }
  .seat:hover { transform: scale(1.1); }
  
  .available { background-color: #1E90FF; }  /* azzurro */
  .reserved { background-color: #FF6347; }   /* rosso */
  .blocked { background-color: #A9A9A9; }    /* grigio */

  .seat::after {
    content: attr(data-info);
    position: absolute;
    bottom: 110%;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: #fff;
    padding: 2px 5px;
    border-radius: 3px;
    font-size: 12px;
    white-space: nowrap;
    opacity: 0; 
    transition: opacity 0.2s;
    pointer-events: none;
  }
  .seat:hover::after { opacity: 1; }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

<h1>Admin - Griglia Prenotazioni</h1>

<div id="controls">
  <button id="resetBtn">Reset Completo Sala</button>
  <button id="exportBtn">Esporta in Excel</button>
</div>

<div id="adminGrid"></div>

<script>
let currentSeatsAdmin = [];

// Carica lo stato dei posti
async function loadAdminSeats() {
  try {
    const res = await fetch('/api/seats');
    const seats = await res.json();
    renderAdminGrid(seats);
    currentSeatsAdmin = seats;
  } catch (err) {
    console.error('Errore caricamento admin:', err);
  }
}

// Render griglia admin
function renderAdminGrid(seats) {
  const grid = document.getElementById('adminGrid');
  if (!grid) return;

  const rows = Math.max(...seats.map(s => s.row_num));
  const cols = Math.max(...seats.map(s => s.col_num));

  grid.style.gridTemplateColumns = `repeat(${cols}, 50px)`;
  grid.innerHTML = '';

  for (let r = 1; r <= rows; r++) {
    for (let c = 1; c <= cols; c++) {
      const seat = seats.find(s => s.row_num === r && s.col_num === c);
      const div = document.createElement('div');
      div.className = 'seat';
      div.style.width = '50px';
      div.style.height = '50px';
      div.style.display = 'flex';
      div.style.alignItems = 'center';
      div.style.justifyContent = 'center';
      div.style.fontWeight = 'bold';
      div.style.borderRadius = '5px';
      div.style.cursor = 'pointer';
      div.style.position = 'relative';

      if (seat) {
        div.id = `seat-${seat.id}`;
        div.textContent = seat.seat_number;
        div.classList.add(seat.status);

        // Tooltip con info prenotazione
        if (seat.status === 'reserved') {
          div.dataset.info = `Prenotato: ${seat.reserved_name} ${seat.reserved_surname} (${seat.reserved_phone})`;
          div.onclick = () => {
            if (confirm('Sei sicuro di eliminare questa prenotazione?')) {
              fetch(`/api/cancel/${seat.id}`, { method: 'DELETE' })
                .then(() => loadAdminSeats());
            }
          };
        } else {
          div.dataset.info = 'Libero';
          div.onclick = null;
        }
      } else {
        div.textContent = '-';
        div.classList.add('blocked');
        div.dataset.info = 'Non disponibile';
        div.onclick = null;
      }

      grid.appendChild(div);
    }
  }
}

// Polling automatico
function startAdminPolling(interval = 1000) {
  setInterval(async () => {
    try {
      const res = await fetch('/api/seats');
      const seats = await res.json();
      if (JSON.stringify(seats) !== JSON.stringify(currentSeatsAdmin)) {
        renderAdminGrid(seats);
        currentSeatsAdmin = seats;
      }
    } catch (err) {
      console.error('Errore polling admin:', err);
    }
  }, interval);
}

// Bottoni reset ed export
document.getElementById('resetBtn').onclick = async () => {
  if (!confirm('Sei sicuro di voler resettare tutti i posti?')) return;
  try {
    const seats = await (await fetch('/api/seats')).json();
    for (const s of seats) {
      await fetch(`/api/cancel/${s.id}`, { method: 'DELETE' });
    }
    alert('Posti resettati!');
    loadAdminSeats();
  } catch (err) {
    console.error('Errore reset:', err);
    alert('Errore nel reset dei posti');
  }
};

document.getElementById('exportBtn').onclick = async () => {
  try {
    const seats = await (await fetch('/api/seats')).json();
    const data = seats.map(s => ({
      Numero: s.seat_number,
      Stato: s.status === 'reserved' ? 'Prenotato' : 'Libero',
      Nome: s.reserved_name || '',
      Cognome: s.reserved_surname || '',
      Telefono: s.reserved_phone || ''
    }));
    const worksheet = XLSX.utils.json_to_sheet(data);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Prenotazioni");
    XLSX.writeFile(workbook, "prenotazioni.xlsx");
  } catch (err) {
    console.error('Errore export:', err);
    alert('Errore esportazione');
  }
};

// Avvio admin
window.onload = () => {
  loadAdminSeats();
  startAdminPolling();
};
</script>

</body>
</html>
